
async function main() {

  const sqlite = require('better-sqlite3')
  const db = sqlite('foobar.db')
  db.pragma('journal_mode = WAL');


  const allsetupsql = `DROP TABLE IF EXISTS image_moderations; DROP TABLE IF EXISTS images; DROP TABLE IF EXISTS log; DROP VIEW IF EXISTS master_image_view; CREATE TABLE log( id INTEGER PRIMARY KEY AUTOINCREMENT, timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP, ip_address VARCHAR(45), user_agent VARCHAR(255)); CREATE TABLE images( id INTEGER PRIMARY KEY AUTOINCREMENT, imagedata BLOB, log_id INTEGER, title VARCHAR(255), FOREIGN KEY(log_id) REFERENCES log(id) ); CREATE TABLE image_moderations( id INTEGER PRIMARY KEY AUTOINCREMENT, image_id INTEGER NOT NULL, approved BOOLEAN NOT NULL, log_id INTEGER, FOREIGN KEY (image_id) REFERENCES images(id), FOREIGN KEY (log_id) REFERENCES log(id) );  INSERT INTO log (ip_address, user_agent) VALUES ('192.168.0.1', 'Mozilla/5.0'); INSERT INTO images (imagedata, log_id, title) VALUES (X'12398B39AB98', 1, 'Funny Cat'); INSERT INTO log (ip_address, user_agent) VALUES ('192.168.0.2', 'Chrome/80.0'); INSERT INTO images (imagedata, log_id, title) VALUES (X'9876CBA54321', 2, 'Crazy Dog'); INSERT INTO log (ip_address, user_agent) VALUES ('192.168.0.3', 'Safari/13.0'); INSERT INTO images (imagedata, log_id, title) VALUES (X'456DEF7890AB', 3, 'Silly Monkey'); INSERT INTO log (ip_address, user_agent) VALUES ('192.168.0.4', 'Firefox/74.0'); INSERT INTO images (imagedata, log_id, title) VALUES (X'ABCDEF123456', 4, 'Cheeky Parrot'); INSERT INTO log (ip_address, user_agent) VALUES ('192.168.0.5', 'Edge/18.0'); INSERT INTO images (imagedata, log_id, title) VALUES (X'7890AB456DEF', 5, 'Goofy Elephant'); INSERT INTO log (ip_address, user_agent) VALUES ('192.168.0.6', 'Opera/67.0'); INSERT INTO images (imagedata, log_id, title) VALUES (X'54321CBA9876', 6, 'Sneaky Snake'); INSERT INTO log (ip_address, user_agent) VALUES ('192.168.0.7', 'Internet Explorer/11.0'); INSERT INTO images (imagedata, log_id, title) VALUES (X'123456ABCDEF', 7, 'Mischievous Rabbit'); INSERT INTO log (ip_address, user_agent) VALUES ('192.168.0.8', 'Brave/1.5'); INSERT INTO images (imagedata, log_id, title) VALUES (X'DEF7890AB456', 8, 'Quirky Penguin'); INSERT INTO log (ip_address, user_agent) VALUES ('192.168.0.9', 'Vivaldi/2.11'); INSERT INTO images (imagedata, log_id, title) VALUES (X'456DEF7890AB', 9, 'Wacky Giraffe'); INSERT INTO log (ip_address, user_agent) VALUES ('192.168.0.10', 'Opera/12.0'); INSERT INTO images (imagedata, log_id, title) VALUES (X'9876543210FE', 10, 'Playful Dolphin'); INSERT INTO log (ip_address, user_agent) VALUES ('192.168.0.11', 'Firefox/80.0'); INSERT INTO images (imagedata, log_id, title) VALUES (X'ABCDEF123456', 11, 'Sneaky Fox'); INSERT INTO log (ip_address, user_agent) VALUES ('192.168.0.12', 'Chrome/85.0'); INSERT INTO images (imagedata, log_id, title) VALUES (X'54321CBA9876', 12, 'Funny Chicken'); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (1, 0, 3); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (2, 1, 3); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (3, 1, 4); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (4, 1, 6); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (3, 1, 6); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (2, 1, 6); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (1, 1, 6); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (2, 1, 7); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (3, 1, 7); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (3, 0, 9); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (1, 0, 9); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (2, 0, 9); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (4, 0, 9); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (6, 1, 8); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (4, 1, 9); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (7, 0, 10); INSERT INTO log (ip_address, user_agent) VALUES ('192.168.0.1', 'Mozilla/5.0'); INSERT INTO log (ip_address, user_agent) VALUES ('192.168.0.2', 'Chrome/80.0'); INSERT INTO log (ip_address, user_agent) VALUES ('192.168.0.3', 'Safari/13.0'); INSERT INTO log (ip_address, user_agent) VALUES ('192.168.0.4', 'Firefox/74.0'); INSERT INTO log (ip_address, user_agent) VALUES ('192.168.0.5', 'Edge/18.0'); INSERT INTO log (ip_address, user_agent) VALUES ('192.168.0.6', 'Opera/67.0'); INSERT INTO log (ip_address, user_agent) VALUES ('192.168.0.7', 'Internet Explorer/11.0'); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (1, 0, 1); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (2, 1, 2); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (3, 1, 3); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (4, 1, 4); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (3, 1, 5); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (2, 1, 6); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (1, 1, 7); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (2, 1, 8); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (3, 1, 9); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (3, 0, 10); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (1, 0, 11); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (2, 0, 12); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (4, 0, 13); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (5, 0, 14); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (6, 1, 15); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (4, 1, 16); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (7, 0, 17); INSERT INTO log (ip_address, user_agent) VALUES ('192.168.0.8', 'Brave/1.5'); INSERT INTO log (ip_address, user_agent) VALUES ('192.168.0.9', 'Vivaldi/2.11'); INSERT INTO log (ip_address, user_agent) VALUES ('192.168.0.10', 'Opera/12.0'); INSERT INTO log (ip_address, user_agent) VALUES ('192.168.0.11', 'Firefox/80.0'); INSERT INTO log (ip_address, user_agent) VALUES ('192.168.0.12', 'Chrome/85.0'); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (1, 0, 1); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (2, 1, 2); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (3, 1, 3); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (4, 1, 4); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (3, 1, 5); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (2, 1, 6); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (1, 1, 7); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (2, 1, 8); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (3, 1, 9); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (3, 0, 10); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (1, 0, 11); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (2, 0, 12); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (4, 0, 13); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (5, 0, 14); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (6, 1, 15); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (4, 1, 16); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (7, 0, 17); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (1, 1, 18); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (2, 0, 18); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (3, 1, 19); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (4, 0, 19); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (5, 1, 20); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (6, 1, 20); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (7, 0, 21); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (1, 0, 19); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (2, 1, 20); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (7, 1, 20); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (3, 1, 20); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (4, 1, 20); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (5, 1, 20); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (6, 0, 21); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (8, 0, 19); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (9, 1, 20); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (11, 1, 20); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (12, 0, 21); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (8, 1, 21); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (9, 1, 22); INSERT INTO image_moderations (image_id, approved, log_id) VALUES (10, 0, 22);

  -- Provides a comprehensive view of all images and their moderation history.
  CREATE VIEW master_image_view AS SELECT images.id, images.imagedata, log.timestamp AS time, images.title, COUNT(image_moderations.id) AS moderation_count, SUM(CASE WHEN image_moderations.approved THEN 1 ELSE 0 END) AS approval_count, SUM(CASE WHEN NOT image_moderations.approved THEN 1 ELSE 0 END) AS denial_count, (SUM(CASE WHEN image_moderations.approved THEN 1 ELSE 0 END) / COUNT(image_moderations.id)) * 100 AS approval_percentage FROM images JOIN log ON images.log_id = log.id LEFT JOIN image_moderations ON images.id = image_moderations.image_id GROUP BY images.id ORDER BY time DESC;
  -- Provides statistics on the approval percentage for each submitted image
  CREATE VIEW image_moderation_info AS SELECT images.id, images.title, COUNT(image_moderations.id) AS moderation_count, CAST(SUM(CASE WHEN approved = 1 THEN 1 ELSE 0 END) AS FLOAT) / COUNT(image_moderations.id) AS approval_percentage FROM images LEFT JOIN image_moderations ON images.id = image_moderations.image_id GROUP BY images.id;
  -- Provides details of all actions performed by visitors 
  CREATE VIEW log_actions AS SELECT log.id, log.timestamp, log.ip_address, log.user_agent, images.id AS image_id, images.title AS image_title, image_moderations.approved FROM log LEFT JOIN images ON log.id = images.log_id LEFT JOIN image_moderations ON images.id = image_moderations.image_id;
  -- Provides an overview of tables and views in the database
  CREATE VIEW db_management AS SELECT name, sql FROM sqlite_master WHERE type='table' OR type='view';
  -- Provides a ranked list of images awaiting moderation
  CREATE VIEW moderation_queue AS SELECT images.id, images.title, COUNT(image_moderations.id) AS moderation_count FROM images LEFT JOIN image_moderations ON images.id = image_moderations.image_id GROUP BY images.id ORDER BY moderation_count ASC;
   `

  allsetupsql.split(';').forEach((sql) => {

    if (sql.trim() === "")
      return;

    console.log("\n\n running sql:\n" + sql + "\n-------------\n")

    const result = db.prepare(sql).run();
    console.log(result)

  });


  console.log(db.prepare("select * from log;").all());





}


function warning() {
  console.log("Warning! Data destruction.")

  return true; // TRUE to enable destruction!!
}

if (warning())
  main()